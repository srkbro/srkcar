<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Driver Dashboard — Car Rent Manager</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 16px; background:#f7fafc; color:#111827; }
  .container{max-width:1100px;margin:0 auto;}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);margin-bottom:12px;}
  label{display:block;font-size:13px;margin-bottom:6px;color:#374151;}
  input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th, td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;}
  .stats{display:flex;gap:10px;}
  .stat{flex:1;padding:10px;border-radius:6px;background:#111827;color:white;text-align:center;}
  .flex{display:flex;gap:8px;}
  .btn{padding:8px 10px;border-radius:6px;border:0;cursor:pointer;}
  .btn-primary{background:#2563eb;color:white;}
  .btn-gray{background:#e5e7eb;}
</style>
</head>

<body>
<div class="container">

  <header>
    <h1>Driver Dashboard — Car Rent Manager</h1>
    <div style="text-align:right">
      Entries: <span id="entryCount">0</span><br>
      <button class="btn btn-gray" id="exportCsvBtn">CSV</button>
      <button class="btn btn-gray" id="exportJsonBtn">JSON</button>
      <input type="file" id="importJson" style="display:none" accept=".json"/>
      <button class="btn btn-gray" id="importJsonBtn">Import JSON</button>
    </div>
  </header>

  <!-- Data Entry -->
  <section class="card">
    <h2>Data Entry</h2>
    <form id="entryForm" class="flex" style="flex-wrap:wrap">
      <div style="flex:1;min-width:150px;">
        <label>Date</label>
        <input type="date" id="date" required>
      </div>
      <div style="flex:1;min-width:150px;">
        <label>Driver</label>
        <input type="text" id="driver" required>
      </div>
      <div style="flex:1;min-width:120px;">
        <label>Rent</label>
        <input type="number" id="rent">
      </div>
      <div style="flex:1;min-width:120px;">
        <label>Fuel</label>
        <input type="number" id="fuel">
      </div>
      <div style="flex:1;min-width:120px;">
        <label>Extra</label>
        <input type="number" id="extra">
      </div>
      <div style="flex:1;min-width:150px;">
        <label>Notes</label>
        <input type="text" id="notes">
      </div>

      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" id="resetBtn" class="btn btn-gray">Reset</button>
    </form>
  </section>

  <!-- Driver percent input -->
  <div style="display:flex;justify-content:flex-end;margin-bottom:8px;gap:8px;align-items:center;">
    <label style="font-size:13px;color:#374151">Driver share %</label>
    <input id="driverPercent" type="number" min="0" max="100" value="40" style="width:70px;">
  </div>

  <!-- Dashboard -->
  <section class="card">
    <h2>Dashboard</h2>

    <div class="stats">
      <div class="stat">
        <div>Total Income</div>
        <div id="totalIncome" style="font-size:20px;font-weight:700">0</div>
      </div>
      <div class="stat">
        <div>Total Expense</div>
        <div id="totalExpense" style="font-size:20px;font-weight:700">0</div>
      </div>
      <div class="stat">
        <div>Profit</div>
        <div id="profit" style="font-size:20px;font-weight:700">0</div>
      </div>
      <div class="stat">
        <div>Driver Income (Share)</div>
        <div id="driverShare" style="font-size:20px;font-weight:700">0</div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
      <div class="card">
        <h3>Daily Income vs Expense</h3>
        <canvas id="dailyChart" height="180"></canvas>
      </div>
      <div class="card">
        <h3>Driver Income (Top)</h3>
        <canvas id="driverChart" height="180"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3>Income vs Expense</h3>
      <canvas id="pieChart" height="150"></canvas>
    </div>
  </section>

  <!-- Entries -->
  <section class="card">
    <h2>Entries</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Driver</th><th>Rent</th><th>Fuel</th><th>Extra</th><th>Profit</th><th>Driver Share</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="entriesBody"></tbody>
    </table>
  </section>

</div>

<script>
(function(){
  const STORAGE_KEY = "driver_dashboard_entries_v1";
  const SETTINGS_KEY = "driver_dashboard_settings_v1";

  let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  let editingId = null;

  const entryCountEl = document.getElementById("entryCount");
  const bodyEl = document.getElementById("entriesBody");
  const driverPercentEl = document.getElementById("driverPercent");

  const totalIncomeEl = document.getElementById("totalIncome");
  const totalExpenseEl = document.getElementById("totalExpense");
  const profitEl = document.getElementById("profit");
  const driverShareEl = document.getElementById("driverShare");

  const form = document.getElementById("entryForm");
  const dateEl = document.getElementById("date");
  const driverEl = document.getElementById("driver");
  const rentEl = document.getElementById("rent");
  const fuelEl = document.getElementById("fuel");
  const extraEl = document.getElementById("extra");
  const notesEl = document.getElementById("notes");

  // Restore saved driver %
  try {
    const st = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
    if(st.driverPercent !== undefined) driverPercentEl.value = st.driverPercent;
  }catch(e){}

  driverPercentEl.addEventListener("change",()=>{
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({driverPercent: Number(driverPercentEl.value)}));
    updateStats();
  });

  // Save entry
  form.addEventListener("submit", e=>{
    e.preventDefault();
    if(!driverEl.value.trim()) return alert("Driver name required");

    const d = {
      id: editingId || Date.now(),
      date: dateEl.value,
      driver: driverEl.value.trim(),
      rent: Number(rentEl.value)||0,
      fuel: Number(fuelEl.value)||0,
      extra: Number(extraEl.value)||0,
      notes: notesEl.value.trim()
    };

    if(editingId){
      entries = entries.map(x => x.id === editingId ? d : x);
      editingId = null;
    } else {
      entries.unshift(d);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    form.reset();
    dateEl.value = new Date().toISOString().slice(0,10);
    render();
    updateStats();
  });

  document.getElementById("resetBtn").onclick = () => {
    form.reset();
    editingId = null;
  };

  function render(){
    bodyEl.innerHTML = "";
    entries.forEach(e=>{
      const profit = e.rent - (e.fuel + e.extra);
      const percent = Number(driverPercentEl.value)||40;
      const dShare = Math.round(profit * percent / 100);

      bodyEl.innerHTML += `
      <tr>
        <td>${e.date}</td>
        <td>${e.driver}</td>
        <td>${e.rent.toLocaleString()}</td>
        <td>${e.fuel.toLocaleString()}</td>
        <td>${e.extra.toLocaleString()}</td>
        <td>${profit.toLocaleString()}</td>
        <td>${dShare.toLocaleString()}</td>
        <td>${e.notes||""}</td>
        <td>
          <button onclick="editEntry(${e.id})">Edit</button>
          <button onclick="deleteEntry(${e.id})">Delete</button>
        </td>
      </tr>`;
    });

    entryCountEl.textContent = entries.length;
  }

  window.editEntry = id=>{
    const e = entries.find(x=>x.id===id);
    if(!e) return;
    editingId = id;
    dateEl.value = e.date;
    driverEl.value = e.driver;
    rentEl.value = e.rent;
    fuelEl.value = e.fuel;
    extraEl.value = e.extra;
    notesEl.value = e.notes;
    window.scrollTo(0,0);
  };

  window.deleteEntry = id=>{
    if(!confirm("Delete?")) return;
    entries = entries.filter(x=>x.id!==id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    render();
    updateStats();
  };

  let dailyChart, driverChart, pieChart;

  function initCharts(){
    dailyChart = new Chart(document.getElementById("dailyChart"), {
      type:"line",
      data:{labels:[],datasets:[
        {label:"Income",data:[],borderWidth:2},
        {label:"Expense",data:[],borderWidth:2}
      ]}
    });

    driverChart = new Chart(document.getElementById("driverChart"), {
      type:"bar",
      data:{labels:[],datasets:[
        {label:"Income",data:[]},
        {label:"Expense",data:[]}
      ]}
    });

    pieChart = new Chart(document.getElementById("pieChart"), {
      type:"pie",
      data:{labels:["Income","Expense"],datasets:[{data:[0,0]}]}
    });
  }

  function updateStats(){
    const totals = {income:0, fuel:0, extra:0};
    entries.forEach(e=>{
      totals.income += e.rent;
      totals.fuel += e.fuel;
      totals.extra += e.extra;
    });

    totals.expense = totals.fuel + totals.extra;
    totals.profit = totals.income - totals.expense;

    totalIncomeEl.textContent = totals.income.toLocaleString();
    totalExpenseEl.textContent = totals.expense.toLocaleString();
    profitEl.textContent = totals.profit.toLocaleString();

    const percent = Number(driverPercentEl.value)||40;
    const dShare = Math.round(totals.profit * percent / 100);
    driverShareEl.textContent = dShare.toLocaleString();

    // Daily chart
    const daily = {};
    entries.forEach(e=>{
      if(!daily[e.date]) daily[e.date] = {income:0,expense:0};
      daily[e.date].income += e.rent;
      daily[e.date].expense += e.fuel + e.extra;
    });

    const dates = Object.keys(daily).sort();
    dailyChart.data.labels = dates;
    dailyChart.data.datasets[0].data = dates.map(d=>daily[d].income);
    dailyChart.data.datasets[1].data = dates.map(d=>daily[d].expense);
    dailyChart.update();

    // Driver chart
    const drivers = {};
    entries.forEach(e=>{
      if(!drivers[e.driver]) drivers[e.driver] = {income:0,expense:0};
      drivers[e.driver].income += e.rent;
      drivers[e.driver].expense += e.fuel + e.extra;
    });

    const dNames = Object.keys(drivers);
    driverChart.data.labels = dNames;
    driverChart.data.datasets[0].data = dNames.map(n=>drivers[n].income);
    driverChart.data.datasets[1].data = dNames.map(n=>drivers[n].expense);
    driverChart.update();

    // Pie chart
    pieChart.data.datasets[0].data = [totals.income, totals.expense];
    pieChart.update();
  }

  document.getElementById("exportCsvBtn").onclick = ()=>{
    if(!entries.length) return alert("No entries");
    const header = "id,date,driver,rent,fuel,extra,notes\n";
    const rows = entries.map(e=>`${e.id},${e.date},"${e.driver}",${e.rent},${e.fuel},${e.extra},"${e.notes}"`);
    const blob = new Blob([header + rows.join("\n")],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="entries.csv"; a.click();
  };

  document.getElementById("exportJsonBtn").onclick = ()=>{
    const blob = new Blob([JSON.stringify(entries,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="entries.json"; a.click();
  };

  document.getElementById("importJsonBtn").onclick = ()=>document.getElementById("importJson").click();
  document.getElementById("importJson").addEventListener("change", function(){
    const file = this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!Array.isArray(data)) return alert("Invalid JSON!");
        entries = data.concat(entries);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        render(); updateStats();
      }catch(err){ alert("Cannot read JSON"); }
    };
    reader.readAsText(file);
  });

  // init
  dateEl.value = new Date().toISOString().slice(0,10);
  initCharts();
  render();
  updateStats();
})();
</script>

</body>
</html>
