<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Driver Dashboard — Car Rent Manager</title>
<link rel="icon" href="data:,">
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', 'Helvetica Neue', Arial; margin: 16px; background:#f7fafc; color:#111827; }
  .container{max-width:1100px;margin:0 auto;}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);margin-bottom:12px;}
  label{display:block;font-size:13px;margin-bottom:6px;color:#374151;}
  input, select, textarea{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;}
  .grid{display:grid;gap:10px;}
  .grid-cols-3{grid-template-columns:repeat(3,1fr);}
  .btn{display:inline-block;padding:8px 10px;border-radius:6px;border:0;cursor:pointer;}
  .btn-primary{background:#2563eb;color:white;}
  .btn-gray{background:#e5e7eb;}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th, td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;}
  .small{text-sm font-size:13px;}
  .flex{display:flex;gap:8px;align-items:center;}
  .stats{display:flex;gap:10px;}
  .stat{flex:1;padding:10px;border-radius:6px;background:#111827;color:white;text-align:center;}
  .download-links{margin-top:8px;}
  .note{font-size:13px;color:#6b7280;margin-top:8px;}
  @media (max-width:800px){ .grid-cols-3{grid-template-columns:1fr;} .stats{flex-direction:column;} }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Driver Dashboard — Car Rent Manager</h1>
    <div>
      <div style="text-align:right">Entries: <span id="entryCount">0</span></div>
      <div class="download-links">
        <button class="btn btn-gray" id="exportCsvBtn">CSV</button>
        <button class="btn btn-gray" id="exportJsonBtn">JSON</button>
        <input type="file" id="importJson" style="display:none" accept=".json"/>
        <button class="btn btn-gray" id="importJsonBtn">Import JSON</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Data Entry</h2>
      <form id="entryForm" class="grid grid-cols-3">
        <div>
          <label>তারিখ (Date)</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label>ড্রাইভার (Driver)</label>
          <input type="text" id="driver" placeholder="Driver name" required />
        </div>
        <div>
          <label>ভাড়া (Rent)</label>
          <input type="number" id="rent" placeholder="0" />
        </div>
        <div>
          <label>জ্বালানি (Fuel)</label>
          <input type="number" id="fuel" placeholder="0" />
        </div>
        <div>
          <label>অন্যান্য (Extra)</label>
          <input type="number" id="extra" placeholder="0" />
        </div>
        <div>
          <label>নোট (Notes)</label>
          <input type="text" id="notes" placeholder="Optional" />
        </div>
        <div style="grid-column:1/-1; display:flex; gap:8px;">
          <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
          <button type="button" class="btn btn-gray" id="resetBtn">Reset</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Entries</h2>
      <div style="overflow:auto;">
        <table id="entriesTable">
          <thead>
            <tr><th>Date</th><th>Driver</th><th>Rent</th><th>Fuel</th><th>Extra</th><th>Profit</th><th>Notes</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">Edit / Delete an entry using Actions. Data stored locally in browser.</div>
    </section>

    <section class="card">
      <h2>Dashboard</h2>
      <div class="stats" style="margin-bottom:12px;">
        <div class="stat"><div style="font-size:13px">Total Income</div><div id="totalIncome" style="font-size:20px;font-weight:700">0</div></div>
        <div class="stat"><div style="font-size:13px">Total Expense</div><div id="totalExpense" style="font-size:20px;font-weight:700">0</div></div>
        <div class="stat"><div style="font-size:13px">Profit</div><div id="profit" style="font-size:20px;font-weight:700">0</div></div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="card">
          <h3>Daily Income vs Expense</h3>
          <canvas id="dailyChart" height="200"></canvas>
        </div>
        <div class="card">
          <h3>Driver Income (Top)</h3>
          <canvas id="driverChart" height="200"></canvas>
        </div>
      </div>

      <div style="margin-top:12px;" class="card">
        <h3>Expense Breakdown</h3>
        <canvas id="pieChart" height="120"></canvas>
      </div>
    </section>
  </main>

  <footer style="text-align:center;margin-top:12px;color:#6b7280;">Made for Swadhin — Car Rent Driver Dashboard</footer>
</div>

<script>
(function(){
  const STORAGE_KEY = 'driver_dashboard_entries_v1';
  let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  let editingId = null;

  // DOM refs
  const entryCountEl = document.getElementById('entryCount');
  const entriesTableBody = document.querySelector('#entriesTable tbody');
  const form = document.getElementById('entryForm');
  const dateInput = document.getElementById('date');
  const driverInput = document.getElementById('driver');
  const rentInput = document.getElementById('rent');
  const fuelInput = document.getElementById('fuel');
  const extraInput = document.getElementById('extra');
  const notesInput = document.getElementById('notes');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const exportJsonBtn = document.getElementById('exportJsonBtn');
  const importJson = document.getElementById('importJson');
  const importJsonBtn = document.getElementById('importJsonBtn');

  const totalIncomeEl = document.getElementById('totalIncome');
  const totalExpenseEl = document.getElementById('totalExpense');
  const profitEl = document.getElementById('profit');

  // Charts
  let dailyChart, driverChart, pieChart;
  function initCharts(){
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    const driverCtx = document.getElementById('driverChart').getContext('2d');
    const pieCtx = document.getElementById('pieChart').getContext('2d');

    dailyChart = new Chart(dailyCtx, {
      type: 'line',
      data: { labels: [], datasets: [{label:'Income', data:[] , fill:false, tension:0.3}, {label:'Expense', data:[], fill:false, tension:0.3}]},
      options:{ responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
    driverChart = new Chart(driverCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{label:'Income', data:[]}, {label:'Expense', data:[]}]},
      options:{ responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
    pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: ['Income','Expense'], datasets:[{data:[0,0]}]},
      options:{ responsive:true }
    });
  }

  function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

  function renderTable(){
    entriesTableBody.innerHTML = '';
    entries.forEach(e => {
      const tr = document.createElement('tr');
      const profit = (Number(e.rent||0) - (Number(e.fuel||0)+Number(e.extra||0))) || 0;
      tr.innerHTML = `<td>${e.date}</td>
                      <td>${e.driver}</td>
                      <td>${Number(e.rent||0).toLocaleString()}</td>
                      <td>${Number(e.fuel||0).toLocaleString()}</td>
                      <td>${Number(e.extra||0).toLocaleString()}</td>
                      <td>${profit.toLocaleString()}</td>
                      <td>${e.notes||''}</td>
                      <td>
                        <button data-id="${e.id}" class="editBtn">Edit</button>
                        <button data-id="${e.id}" class="delBtn">Delete</button>
                      </td>`;
      entriesTableBody.appendChild(tr);
    });
    entryCountEl.textContent = entries.length;
    // attach listeners
    document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', onEdit));
    document.querySelectorAll('.delBtn').forEach(btn => btn.addEventListener('click', onDelete));
  }

  function aggregate(){
    const totals = { income:0, fuel:0, extra:0 };
    entries.forEach(e => {
      totals.income += Number(e.rent||0);
      totals.fuel += Number(e.fuel||0);
      totals.extra += Number(e.extra||0);
    });
    totals.expense = totals.fuel + totals.extra;
    totals.profit = totals.income - totals.expense;
    return totals;
  }

  function updateStatsAndCharts(){
    const totals = aggregate();
    totalIncomeEl.textContent = totals.income.toLocaleString();
    totalExpenseEl.textContent = totals.expense.toLocaleString();
    profitEl.textContent = totals.profit.toLocaleString();

    // Daily
    const daily = {};
    entries.forEach(e => {
      if(!daily[e.date]) daily[e.date] = { income:0, expense:0 };
      daily[e.date].income += Number(e.rent||0);
      daily[e.date].expense += Number(e.fuel||0) + Number(e.extra||0);
    });
    const dailyKeys = Object.keys(daily).sort();
    dailyChart.data.labels = dailyKeys;
    dailyChart.data.datasets[0].data = dailyKeys.map(k => daily[k].income);
    dailyChart.data.datasets[1].data = dailyKeys.map(k => daily[k].expense);
    dailyChart.update();

    // Driver
    const drivers = {};
    entries.forEach(e => {
      const k = e.driver || 'Unknown';
      if(!drivers[k]) drivers[k] = { income:0, expense:0 };
      drivers[k].income += Number(e.rent||0);
      drivers[k].expense += Number(e.fuel||0) + Number(e.extra||0);
    });
    const driverSorted = Object.entries(drivers).sort((a,b)=>b[1].income - a[1].income);
    const driverLabels = driverSorted.map(d=>d[0]);
    driverChart.data.labels = driverLabels;
    driverChart.data.datasets[0].data = driverSorted.map(d=>d[1].income);
    driverChart.data.datasets[1].data = driverSorted.map(d=>d[1].expense);
    driverChart.update();

    // Pie
    pieChart.data.datasets[0].data = [totals.income, totals.expense];
    pieChart.update();
  }

  function onEdit(evt){
    const id = evt.currentTarget.dataset.id;
    const e = entries.find(x=>String(x.id)===String(id));
    if(!e) return;
    editingId = e.id;
    dateInput.value = e.date;
    driverInput.value = e.driver;
    rentInput.value = e.rent;
    fuelInput.value = e.fuel;
    extraInput.value = e.extra;
    notesInput.value = e.notes;
    saveBtn.textContent = 'Update';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function onDelete(evt){
    const id = evt.currentTarget.dataset.id;
    if(!confirm('Delete korte chan?')) return;
    entries = entries.filter(x=>String(x.id)!==String(id));
    saveToStorage(); renderTable(); updateStatsAndCharts();
  }

  form.addEventListener('submit', function(ev){
    ev.preventDefault();
    const data = {
      id: editingId || Date.now(),
      date: dateInput.value || new Date().toISOString().slice(0,10),
      driver: driverInput.value.trim(),
      rent: Number(rentInput.value)||0,
      fuel: Number(fuelInput.value)||0,
      extra: Number(extraInput.value)||0,
      notes: notesInput.value.trim()
    };
    if(!data.driver){ alert('Driver name proyojon'); return; }
    if(editingId){
      entries = entries.map(x=> x.id===editingId ? data : x);
      editingId = null;
      saveBtn.textContent = 'Save';
    } else {
      entries.unshift(data);
    }
    saveToStorage();
    form.reset();
    dateInput.value = new Date().toISOString().slice(0,10);
    renderTable();
    updateStatsAndCharts();
  });

  resetBtn.addEventListener('click', function(){ form.reset(); dateInput.value = new Date().toISOString().slice(0,10); editingId = null; saveBtn.textContent='Save'; });

  exportCsvBtn.addEventListener('click', function(){
    if(!entries.length){ alert('No entries'); return; }
    const header = ['id','date','driver','rent','fuel','extra','notes'];
    const rows = entries.map(e=> [e.id, e.date, `"\${e.driver.replace(/"/g,'""')}"`, e.rent, e.fuel, e.extra, `"\${(e.notes||'').replace(/"/g,'""')}"`].join(','));
    const csv = header.join(',') + '\n' + rows.join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='driver_entries.csv'; a.click(); URL.revokeObjectURL(url);
  });

  exportJsonBtn.addEventListener('click', function(){
    const blob = new Blob([JSON.stringify(entries, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='driver_entries.json'; a.click(); URL.revokeObjectURL(url);
  });

  importJsonBtn.addEventListener('click', ()=> importJson.click());
  importJson.addEventListener('change', function(ev){
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try {
        const data = JSON.parse(e.target.result);
        if(!Array.isArray(data)) throw new Error('Invalid format');
        entries = data.concat(entries);
        saveToStorage(); renderTable(); updateStatsAndCharts();
        alert('Import complete');
      } catch(err){ alert('Invalid JSON file'); }
    };
    reader.readAsText(f);
    importJson.value = '';
  });

  // init
  dateInput.value = new Date().toISOString().slice(0,10);
  initCharts();
  renderTable();
  updateStatsAndCharts();
})();
</script>
</body>
</html>