<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GO FAST RENT-A CAR</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--muted:#94a3b8;--white:#e6eef8;--radius:12px;--max-width:900px;--gap:12px;font-family:Inter,system-ui,Arial;}
    *{box-sizing:border-box}html,body{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%,#071426 100%);color:var(--white);-webkit-font-smoothing:antialiased}
    .container{max-width:var(--max-width);margin:18px auto;padding:14px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#3b82f6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021426}
    .title{font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:#021426}
    .entry-card{padding:10px;border-radius:10px;background:var(--card);border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .small{font-size:13px;color:var(--muted)}
    .driver-percent{width:84px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);text-align:center}
    @media(min-width:860px){.entries-list{display:none}.table-wrap{display:block}table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}th{color:var(--muted);font-size:12px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">SR</div>
        <div>
          <div class="title">GO FAST RENT-A CAR</div>
          <div class="sub">Car Rent Manager</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="text-align:right"><div class="small">Entries</div><div id="entryCount" style="font-weight:700">0</div></div>
        <button id="exportBtn" class="btn">‚§ì</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Add / Edit Entry</div>
        <div style="display:flex;align-items:center;gap:8px"><label class="small">‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡¶æ‡¶∞ %</label><input id="driverPercent" class="driver-percent" type="number" min="0" max="100" value="40" /></div>
      </div>

      <form id="entryForm" style="display:grid;gap:8px">
        <input id="date" class="input" type="date" required />
        <input id="driver" class="input" placeholder="‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" required />
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <input id="rent" class="input" placeholder="‡¶≠‡¶æ‡¶°‡¶º‡¶æ" type="number" />
          <input id="fuel" class="input" placeholder="‡¶ú‡ßç‡¶¨‡¶æ‡¶≤‡¶æ‡¶®‡¶ø" type="number" />
          <input id="extra" class="input" placeholder="‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§" type="number" />
        </div>
        <input id="notes" class="input" placeholder="‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" />
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" type="submit">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button>
          <button class="btn" type="button" id="resetBtn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
          <button class="btn" type="button" id="importBtn">‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Overview</div><div class="small">Live numbers</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px">
        <div class="card"><div class="small">Total Income</div><div id="totalIncome" style="font-weight:700">0</div></div>
        <div class="card"><div class="small">Total Expense</div><div id="totalExpense" style="font-weight:700">0</div></div>
        <div class="card"><div class="small">Profit</div><div id="profit" style="font-weight:700">0</div></div>
        <div class="card"><div class="small">Driver Income</div><div id="driverShare" style="font-weight:700">0</div></div>
      </div>
      <div class="charts" style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px">
        <canvas id="dailyChart" height="140"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Entries</div><div class="small">Tap item to edit</div>
      </div>
      <div class="entries-list" id="entriesList"></div>
      <div class="table-wrap" id="tableWrap" style="display:none;margin-top:8px">
        <table><thead><tr><th>Date</th><th>Driver</th><th>Rent</th><th>Fuel</th><th>Extra</th><th>Profit</th><th>Driver</th></tr></thead><tbody id="entriesTable"></tbody></table>
      </div>
    </div>

    <div class="small" style="margin-top:12px;text-align:center">¬© 2025 Md Sadikur Rahman Shadhin ‚Äî All rights reserved</div>
  </div>

  <input type="file" id="importJson" accept=".json" style="display:none">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // ------------------ FIREBASE CONFIG (CONFIRMED) ------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDcYaxhTXO2LYPnqGMD_hcJC4hxTMKLV8I",
      authDomain: "shadhin-portfolio.firebaseapp.com",
      projectId: "shadhin-portfolio",
      storageBucket: "shadhin-portfolio.firebasestorage.app",
      messagingSenderId: "362689759294",
      appId: "1:362689759294:web:5d96f92628bf137124296f"
    };
    // -----------------------------------------------------------------

    // initialize firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const entriesCol = collection(db, "entries");
    const settingsDocRef = doc(db, "meta", "settings");

    const STORAGE_KEY = 'driver_dashboard_entries_v1';
    const SETTINGS_KEY = 'driver_dashboard_settings_v1';

    // DOM refs
    const entryCountEl = document.getElementById('entryCount');
    const entriesList = document.getElementById('entriesList');
    const entriesTable = document.getElementById('entriesTable');
    const dateEl = document.getElementById('date');
    const driverEl = document.getElementById('driver');
    const rentEl = document.getElementById('rent');
    const fuelEl = document.getElementById('fuel');
    const extraEl = document.getElementById('extra');
    const notesEl = document.getElementById('notes');
    const driverPercentEl = document.getElementById('driverPercent');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const profitEl = document.getElementById('profit');
    const driverShareEl = document.getElementById('driverShare');
    const importJson = document.getElementById('importJson');

    let dailyChart, driverChart;
    function format(n){ return Number(n).toLocaleString(); }

    // local fallback entries while firestore loads
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let editingId = null;

    // Load settings from Firestore first (if exists), else localStorage
    async function loadSettings() {
      try {
        const snap = await getDoc(settingsDocRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.driverPercent !== undefined) {
            driverPercentEl.value = data.driverPercent;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({driverPercent: data.driverPercent}));
          }
        } else {
          const st = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
          if (st.driverPercent !== undefined) driverPercentEl.value = st.driverPercent;
        }
      } catch (err) {
        console.warn("Could not load settings from Firestore:", err);
        const st = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
        if (st.driverPercent !== undefined) driverPercentEl.value = st.driverPercent;
      }
    }

    driverPercentEl.addEventListener('change', async ()=>{
      const v = Number(driverPercentEl.value) || 0;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({driverPercent: v}));
      try {
        await setDoc(settingsDocRef, { driverPercent: v }, { merge: true });
      } catch(e) { console.warn("Settings save failed:", e); }
      render();
      updateStats();
    });

    function saveLocalEntries(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

    // Firestore query and realtime listener
    const q = query(entriesCol, orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      const docs = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        docs.push({
          id: docSnap.id,
          date: data.date || new Date().toISOString().slice(0,10),
          driver: data.driver || "",
          rent: Number(data.rent || 0),
          fuel: Number(data.fuel || 0),
          extra: Number(data.extra || 0),
          notes: data.notes || ""
        });
      });
      entries = docs;
      saveLocalEntries();
      render();
      updateStats();
    }, (err) => {
      console.warn("Firestore snapshot error:", err);
      render();
      updateStats();
    });

    async function upsertEntryToFirestore(obj) { 
      try { 
        const docRef = doc(entriesCol, String(obj.id));
        await setDoc(docRef, { 
          date: obj.date, driver: obj.driver, rent: obj.rent, fuel: obj.fuel, extra: obj.extra, notes: obj.notes,
          createdAt: Date.now()
        }, { merge: true });
      } catch (e) { console.error("upsert failed", e); }
    }

    async function deleteEntryFromFirestore(id) { 
      try { await deleteDoc(doc(entriesCol, String(id))); } catch (e) { console.error("delete failed", e); }
    }

    document.getElementById('entryForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if(!driverEl.value.trim()){ alert('Driver name required'); return; }
      const obj = {
        id: editingId || Date.now(),
        date: dateEl.value || new Date().toISOString().slice(0,10),
        driver: driverEl.value.trim(),
        rent: Number(rentEl.value)||0,
        fuel: Number(fuelEl.value)||0,
        extra: Number(extraEl.value)||0,
        notes: notesEl.value||''
      };
      if(editingId){ entries = entries.map(x=> x.id===editingId ? obj : x); editingId = null; } else { entries.unshift(obj); }
      saveLocalEntries();
      render(); updateStats();
      await upsertEntryToFirestore(obj);
      document.getElementById('entryForm').reset();
      dateEl.value = new Date().toISOString().slice(0,10);
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('entryForm').reset(); editingId = null; dateEl.value = new Date().toISOString().slice(0,10); });

    document.getElementById('importBtn').addEventListener('click', ()=> importJson.click());
    importJson.addEventListener('change', function(){
      const f = this.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = async (e)=>{
        try{
          const data = JSON.parse(e.target.result);
          if(!Array.isArray(data)) throw 'Invalid';
          for(const item of data){
            const id = item.id || Date.now() + Math.floor(Math.random()*10000);
            const obj = {
              id: id,
              date: item.date || new Date().toISOString().slice(0,10),
              driver: item.driver || '',
              rent: Number(item.rent)||0,
              fuel: Number(item.fuel)||0,
              extra: Number(item.extra)||0,
              notes: item.notes || ''
            };
            await upsertEntryToFirestore(obj);
          }
          alert('Imported to Firestore');
        }catch(err){ alert('Invalid JSON file'); }
      };
      r.readAsText(f); this.value='';
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='driver_entries.json'; a.click(); URL.revokeObjectURL(url);
    });

    window.editEntry = function(id){ const e = entries.find(x=>x.id===id); if(!e) return; editingId = id; dateEl.value = e.date; driverEl.value = e.driver; rentEl.value = e.rent; fuelEl.value = e.fuel; extraEl.value = e.extra; notesEl.value = e.notes; window.scrollTo({top:0,behavior:'smooth'}); };

    window.deleteEntry = async function(id){ if(!confirm('Delete?')) return; entries = entries.filter(x=> x.id!==id); saveLocalEntries(); render(); updateStats(); await deleteEntryFromFirestore(id); };

    function initCharts(){ try{ const ctx1 = document.getElementById('dailyChart').getContext('2d'); dailyChart = new Chart(ctx1, { type:'line', data:{ labels:[], datasets:[ {label:'Income', data:[], fill:false, tension:0.3}, {label:'Expense', data:[], fill:false, tension:0.3} ] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} } }); const ctx2canvas = document.createElement('canvas'); ctx2canvas.style.display='none'; document.body.appendChild(ctx2canvas); }catch(e){console.warn('chart init', e)} }
    function updateStats(){ const totals = {income:0,fuel:0,extra:0}; entries.forEach(e=>{ totals.income += e.rent; totals.fuel += e.fuel; totals.extra += e.extra; }); totals.expense = totals.fuel + totals.extra; totals.profit = totals.income - totals.expense; totalIncomeEl.textContent = format(totals.income); totalExpenseEl.textContent = format(totals.expense); profitEl.textContent = format(totals.profit); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(totals.profit * percent / 100)); driverShareEl.textContent = format(dShare); try{ const daily = {}; entries.forEach(e=>{ if(!daily[e.date]) daily[e.date] = {income:0,expense:0}; daily[e.date].income += e.rent; daily[e.date].expense += (e.fuel + e.extra); }); const dates = Object.keys(daily).sort(); if(dailyChart){ dailyChart.data.labels = dates; dailyChart.data.datasets[0].data = dates.map(d=>daily[d].income); dailyChart.data.datasets[1].data = dates.map(d=>daily[d].expense); dailyChart.update(); } }catch(e){} }
    function render(){ entryCountEl.textContent = entries.length; entriesList.innerHTML = ''; entries.forEach(e=>{ const profit = e.rent - (e.fuel + e.extra); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(profit * percent / 100)); const card = document.createElement('div'); card.className='entry-card'; card.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">'+e.driver+'</div><div class="small">'+e.date+' ¬∑ '+format(e.rent)+'</div></div><div style="text-align:right"><div style="font-weight:700">Profit: '+format(profit)+'</div><div class="small">Driver: '+format(dShare)+'</div></div></div><div style="display:flex;justify-content:space-between;margin-top:8px;align-items:center"><div class="small">'+(e.notes||'')+'</div><div style="display:flex;gap:8px"><button class="btn" onclick="editEntry('+e.id+')">‚úé</button><button class="btn" onclick="deleteEntry('+e.id+')">üóë</button></div></div>'; card.addEventListener('click', function(ev){ if(ev.target.tagName.toLowerCase() !== 'button') editEntry(e.id); }); entriesList.appendChild(card); }); entriesTable.innerHTML = ''; entries.forEach(e=>{ const profit = e.rent - (e.fuel + e.extra); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(profit * percent / 100)); const tr = document.createElement('tr'); tr.innerHTML = '<td>'+e.date+'</td><td>'+e.driver+'</td><td>'+format(e.rent)+'</td><td>'+format(e.fuel)+'</td><td>'+format(e.extra)+'</td><td>'+format(profit)+'</td><td>'+format(dShare)+'</td>'; entriesTable.appendChild(tr); }); updateStats(); }

    // init
    initCharts();
    loadSettings().then(()=>{ render(); updateStats(); });
  </script>
</body>
</html>