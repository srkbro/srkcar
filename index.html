<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GO FAST RENT-A CAR</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ================= PREMIUM THEME ================= -->
  <style>
  :root{
    --bg:#060b1a;
    --bg-2:#0a122a;
    --card:rgba(255,255,255,0.06);
    --border:rgba(255,255,255,0.12);
    --muted:#9aa4c7;
    --white:#eef2ff;
    --accent1:#22d3ee;
    --accent2:#6366f1;
    --radius:16px;
    --max-width:900px;
    --gap:14px;
    font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, Arial;
  }

  *{box-sizing:border-box}

  html,body{
    height:100%;
    margin:0;
    background:
      radial-gradient(1200px 600px at 10% -10%, #1e3a8a55, transparent 60%),
      radial-gradient(900px 500px at 90% 10%, #06b6d455, transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
    color:var(--white);
    -webkit-font-smoothing:antialiased;
  }

  .container{
    max-width:var(--max-width);
    margin:20px auto;
    padding:16px;
    animation:fadeUp .6s ease both;
  }

  @keyframes fadeUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:none}
  }

  /* ===== HEADER ===== */
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
  }

  .brand{display:flex;align-items:center;gap:12px}

  .logo{
    width:56px;height:56px;
    border-radius:14px;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    display:flex;align-items:center;justify-content:center;
    font-weight:800;
    color:#020617;
    box-shadow:0 10px 30px rgba(34,211,238,.35);
  }

  .title{font-weight:800;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:13px}

  /* ===== CARD / GLASS ===== */
  .card{
    background:linear-gradient(
      180deg,
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.03)
    );
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    padding:14px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.15),
      0 20px 40px rgba(0,0,0,.35);
    transition:transform .25s ease, box-shadow .25s ease;
  }

  .card:hover{
    transform:translateY(-2px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.2),
      0 30px 60px rgba(0,0,0,.45);
  }

  /* ===== INPUTS ===== */
  .input{
    width:100%;
    padding:11px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    color:var(--white);
    outline:none;
    transition:border .2s ease, box-shadow .2s ease;
  }

  .input:focus{
    border-color:var(--accent1);
    box-shadow:0 0 0 3px rgba(34,211,238,.2);
  }

  /* ===== DATE FIELD (PREMIUM FIX) ===== */
  input[type="date"]{
    color: var(--white);
    font-weight: 600;
    letter-spacing: .4px;
    background:
      linear-gradient(
        180deg,
        rgba(255,255,255,0.12),
        rgba(255,255,255,0.04)
      );
    border: 1px solid rgba(255,255,255,0.28);
  }

  input[type="date"]::-webkit-calendar-picker-indicator{
    filter: invert(1) brightness(1.6);
    opacity: 1;
    cursor: pointer;
  }

  input[type="date"]:hover{
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(34,211,238,.18);
  }

  input[type="date"]:focus{
    border-color: var(--accent2);
    box-shadow: 0 0 0 3px rgba(99,102,241,.28);
  }

  /* ===== BUTTONS ===== */
  .btn{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    color:var(--white);
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
  }

  .btn:hover{
    transform:translateY(-1px);
    background:rgba(255,255,255,0.08);
    box-shadow:0 10px 20px rgba(0,0,0,.3);
  }

  .btn:active{transform:scale(.97)}

  .btn-primary{
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#020617;
    font-weight:700;
    border:none;
    box-shadow:0 12px 30px rgba(99,102,241,.35);
  }

  /* ===== FORM STAGGER ANIMATION ===== */
  #entryForm > *{
    opacity:0;
    transform:translateY(6px);
    animation:formIn .45s ease forwards;
  }

  #entryForm > *:nth-child(1){animation-delay:.05s}
  #entryForm > *:nth-child(2){animation-delay:.10s}
  #entryForm > *:nth-child(3){animation-delay:.15s}
  #entryForm > *:nth-child(4){animation-delay:.20s}
  #entryForm > *:nth-child(5){animation-delay:.25s}
  #entryForm > *:nth-child(6){animation-delay:.30s}

  @keyframes formIn{
    to{opacity:1;transform:none}
  }

  /* ===== ENTRY CARDS ===== */
  .entry-card{
    padding:12px;
    border-radius:14px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    margin-bottom:10px;
    transition:transform .2s ease, box-shadow .2s ease;
  }

  .entry-card:hover{
    transform:translateY(-2px);
    box-shadow:0 14px 28px rgba(0,0,0,.35);
  }

  .small{font-size:13px;color:var(--muted)}

  .driver-percent{
    width:90px;
    padding:8px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    color:var(--white);
    text-align:center;
  }

  /* ===== TABLE ===== */
  table{width:100%;border-collapse:collapse}
  th,td{
    padding:12px;
    border-bottom:1px solid var(--border);
    text-align:left;
  }
  th{color:var(--muted);font-size:12px}

  /* ===== CHART PREMIUM GLOW ===== */
  .charts canvas{
    background:linear-gradient(
      180deg,
      rgba(255,255,255,0.06),
      rgba(255,255,255,0.02)
    );
    border-radius:16px;
    padding:10px;
    border:1px solid rgba(255,255,255,0.14);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.15),
      0 20px 40px rgba(0,0,0,.35);
  }

  .charts canvas:hover{
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.2),
      0 30px 60px rgba(0,0,0,.45);
  }

  @media(min-width:860px){
    .entries-list{display:none}
    .table-wrap{display:block}
  }
</style>
  <!-- ================================================= -->
</head>

<!-- ðŸ”´ BODY + SCRIPT à¦…à¦‚à¦¶ à¦à¦•à¦¦à¦® à¦…à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¿à¦¤ -->
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">SR</div>
        <div>
          <div class="title">GO FAST RENT-A CAR</div>
          <div class="sub" data-key="sub_title">Car Rent Manager</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="text-align:right">
          <div class="small" data-key="entries_label">Entries</div>
          <div id="entryCount" style="font-weight:700">0</div>
        </div>
        <button id="exportBtn" class="btn" title="Export">â¤“</button>
        <button id="langToggle" class="btn">à¦¬à¦¾à¦‚à¦²à¦¾</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700" data-key="add_edit">Add / Edit Entry</div>
        <div style="display:flex;align-items:center;gap:8px">
          <label class="small" data-key="driver_percent_label">Driver %</label>
          <input id="driverPercent" class="driver-percent" type="number" min="0" max="100" value="40" />
        </div>
      </div>

      <form id="entryForm" style="display:grid;gap:8px">
        <input id="date" class="input" type="date" required data-key="date_field" />
        <input id="driver" class="input" placeholder="Driver name" required data-key="driver_ph" />
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <input id="rent" class="input" placeholder="Rent" type="number" data-key="rent_ph" />
          <input id="fuel" class="input" placeholder="Fuel" type="number" data-key="fuel_ph" />
          <input id="extra" class="input" placeholder="Extra" type="number" data-key="extra_ph" />
        </div>
        <input id="notes" class="input" placeholder="Notes (optional)" data-key="notes_ph" />
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" type="submit" data-key="save_btn">Save</button>
          <button class="btn" type="button" id="resetBtn" data-key="reset_btn">Reset</button>
          <button class="btn" type="button" id="importBtn" data-key="import_btn">Import</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700" data-key="overview">Overview</div>
        <div class="small" data-key="live_numbers">Live numbers</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px">
        <div class="card"><div class="small" data-key="total_income">Total Income</div><div id="totalIncome" style="font-weight:700">0</div></div>
        <div class="card"><div class="small" data-key="total_expense">Total Expense</div><div id="totalExpense" style="font-weight:700">0</div></div>
        <div class="card"><div class="small" data-key="profit">Profit</div><div id="profit" style="font-weight:700">0</div></div>
        <div class="card"><div class="small" data-key="driver_income">Driver Income</div><div id="driverShare" style="font-weight:700">0</div></div>
      </div>
      <div class="charts" style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px">
        <canvas id="dailyChart" height="140"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700" data-key="entries_title">Entries</div>
        <div class="small" data-key="tap_edit">Tap item to edit</div>
      </div>
      <div class="entries-list" id="entriesList"></div>
      <div class="table-wrap" id="tableWrap" style="display:none;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th data-key="th_date">Date</th>
              <th data-key="th_driver">Driver</th>
              <th data-key="th_rent">Rent</th>
              <th data-key="th_fuel">Fuel</th>
              <th data-key="th_extra">Extra</th>
              <th data-key="th_profit">Profit</th>
              <th data-key="th_driver_share">Driver</th>
            </tr>
          </thead>
          <tbody id="entriesTable"></tbody>
        </table>
      </div>
    </div>

    <div class="small" style="margin-top:12px;text-align:center" data-key="footer_copy">Â© 2025 Md Sadikur Rahman Shadhin â€” All rights reserved</div>
  </div>

  <input type="file" id="importJson" accept=".json" style="display:none">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // ------------------ FIREBASE CONFIG (CONFIRMED) ------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDcYaxhTXO2LYPnqGMD_hcJC4hxTMKLV8I",
      authDomain: "shadhin-portfolio.firebaseapp.com",
      projectId: "shadhin-portfolio",
      storageBucket: "shadhin-portfolio.firebasestorage.app",
      messagingSenderId: "362689759294",
      appId: "1:362689759294:web:5d96f92628bf137124296f"
    };
    // -----------------------------------------------------------------

    // initialize firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const entriesCol = collection(db, "entries");
    const settingsDocRef = doc(db, "meta", "settings");

    const STORAGE_KEY = 'driver_dashboard_entries_v1';
    const SETTINGS_KEY = 'driver_dashboard_settings_v1';

    // DOM refs
    const entryCountEl = document.getElementById('entryCount');
    const entriesList = document.getElementById('entriesList');
    const entriesTable = document.getElementById('entriesTable');
    const dateEl = document.getElementById('date');
    const driverEl = document.getElementById('driver');
    const rentEl = document.getElementById('rent');
    const fuelEl = document.getElementById('fuel');
    const extraEl = document.getElementById('extra');
    const notesEl = document.getElementById('notes');
    const driverPercentEl = document.getElementById('driverPercent');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const profitEl = document.getElementById('profit');
    const driverShareEl = document.getElementById('driverShare');
    const importJson = document.getElementById('importJson');
    const langToggleBtn = document.getElementById('langToggle');

    let dailyChart;
    function format(n){ return Number(n).toLocaleString(); }

    // local fallback entries while firestore loads
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let editingId = null;

    // ---- Language data ----
    const langData = {
      en: {
        sub_title: "Car Rent Manager",
        entries_label: "Entries",
        add_edit: "Add / Edit Entry",
        driver_percent_label: "Driver %",
        date_field: "Date",
        driver_ph: "Driver name",
        rent_ph: "Rent",
        fuel_ph: "Fuel",
        extra_ph: "Extra",
        notes_ph: "Notes (optional)",
        save_btn: "Save",
        reset_btn: "Reset",
        import_btn: "Import",
        overview: "Overview",
        live_numbers: "Live numbers",
        total_income: "Total Income",
        total_expense: "Total Expense",
        profit: "Profit",
        driver_income: "Driver Income",
        entries_title: "Entries",
        tap_edit: "Tap item to edit",
        th_date: "Date",
        th_driver: "Driver",
        th_rent: "Rent",
        th_fuel: "Fuel",
        th_extra: "Extra",
        th_profit: "Profit",
        th_driver_share: "Driver",
        footer_copy: "Â© 2025 Md Sadikur Rahman Shadhin â€” All rights reserved",
        driver_name_required: "Driver name required",
        imported_ok: "Imported to Firestore",
        invalid_json: "Invalid JSON file",
        delete_confirm: "Delete?",
        income: "Income",
        expense: "Expense",
        profit_label: "Profit:",
        driver_label: "Driver:"
      },
      bn: {
        sub_title: "à¦—à¦¾à¦¡à¦¼à¦¿ à¦­à¦¾à¦¡à¦¼à¦¾ à¦®à§à¦¯à¦¾à¦¨à§‡à¦œà¦¾à¦°",
        entries_label: "à¦à¦¨à§à¦Ÿà§à¦°à¦¿",
        add_edit: "à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¯à§‹à¦— / à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾",
        driver_percent_label: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦° %",
        date_field: "à¦¤à¦¾à¦°à¦¿à¦–",
        driver_ph: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°à§‡à¦° à¦¨à¦¾à¦®",
        rent_ph: "à¦­à¦¾à¦¡à¦¼à¦¾",
        fuel_ph: "à¦œà§à¦¬à¦¾à¦²à¦¾à¦¨à¦¿",
        extra_ph: "à¦…à¦¤à¦¿à¦°à¦¿à¦•à§à¦¤",
        notes_ph: "à¦®à¦¨à§à¦¤à¦¬à§à¦¯ (à¦à¦šà§à¦›à¦¿à¦•)",
        save_btn: "à¦¸à¦‚à¦°à¦•à§à¦·à¦£",
        reset_btn: "à¦°à¦¿à¦¸à§‡à¦Ÿ",
        import_btn: "à¦‡à¦®à§à¦ªà§‹à¦°à§à¦Ÿ",
        overview: "à¦¸à¦¾à¦°à¦¾à¦‚à¦¶",
        live_numbers: "à¦²à¦¾à¦‡à¦­ à¦¹à¦¿à¦¸à¦¾à¦¬",
        total_income: "à¦®à§‹à¦Ÿ à¦†à§Ÿ",
        total_expense: "à¦®à§‹à¦Ÿ à¦–à¦°à¦š",
        profit: "à¦²à¦¾à¦­",
        driver_income: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°à§‡à¦° à¦ªà§à¦°à¦¾à¦ªà§à¦¯",
        entries_title: "à¦¸à¦®à¦¸à§à¦¤ à¦à¦¨à§à¦Ÿà§à¦°à¦¿",
        tap_edit: "à¦à¦¡à¦¿à¦Ÿ à¦•à¦°à¦¤à§‡ à¦šà¦¾à¦ª à¦¦à¦¿à¦¨",
        th_date: "à¦¤à¦¾à¦°à¦¿à¦–",
        th_driver: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°",
        th_rent: "à¦­à¦¾à¦¡à¦¼à¦¾",
        th_fuel: "à¦œà§à¦¬à¦¾à¦²à¦¾à¦¨à¦¿",
        th_extra: "à¦…à¦¤à¦¿à¦°à¦¿à¦•à§à¦¤",
        th_profit: "à¦²à¦¾à¦­",
        th_driver_share: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°",
        footer_copy: "Â© 2025 Md Sadikur Rahman Shadhin â€” à¦¸à¦°à§à¦¬à¦¸à§à¦¬à¦¤à§à¦¬ à¦¸à¦‚à¦°à¦•à§à¦·à¦¿à¦¤",
        driver_name_required: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°à§‡à¦° à¦¨à¦¾à¦® à¦¦à¦¿à¦¤à§‡ à¦¹à¦¬à§‡",
        imported_ok: "Firestore-à¦ à¦‡à¦®à§à¦ªà§‹à¦°à§à¦Ÿ à¦¹à§Ÿà§‡à¦›à§‡",
        invalid_json: "à¦…à¦¬à§ˆà¦§ JSON à¦«à¦¾à¦‡à¦²",
        delete_confirm: "à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨?",
        income: "à¦†à§Ÿ",
        expense: "à¦–à¦°à¦š",
        profit_label: "à¦²à¦¾à¦­:",
        driver_label: "à¦¡à§à¦°à¦¾à¦‡à¦­à¦¾à¦°:"
      }
    };

    // helper for current language
    let currentLang = localStorage.getItem("lang") || "bn"; // default à¦¬à¦¾à¦‚à¦²à¦¾
    function t(key){
      return (langData[currentLang] && langData[currentLang][key]) || key;
    }

    function applyLanguage(lang){
      currentLang = lang;
      // apply to elements with data-key
      document.querySelectorAll("[data-key]").forEach(el=>{
        const key = el.getAttribute("data-key");
        if(!key) return;
        // inputs/textareas -> placeholder
        const tag = el.tagName.toLowerCase();
        if(tag === 'input' || tag === 'textarea'){
          const type = el.getAttribute('type');
          // if it's date type we'll not change placeholder
          if(type && type.toLowerCase()==='date') return;
          el.placeholder = (langData[lang] && langData[lang][key]) || el.placeholder;
        } else {
          el.textContent = (langData[lang] && langData[lang][key]) || el.textContent;
        }
      });

      // lang toggle button text: show the other language name
      langToggleBtn.textContent = (lang === 'en') ? 'à¦¬à¦¾à¦‚à¦²à¦¾' : 'English';

      // update chart labels if chart exists
      if(dailyChart && dailyChart.data && dailyChart.data.datasets){
        dailyChart.data.datasets[0].label = t('income');
        dailyChart.data.datasets[1].label = t('expense');
        dailyChart.update();
      }
    }

    // init chosen language
    applyLanguage(currentLang);

    // Save settings (driver percent) to Firestore/local
    async function loadSettings() {
      try {
        const snap = await getDoc(settingsDocRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.driverPercent !== undefined) {
            driverPercentEl.value = data.driverPercent;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({driverPercent: data.driverPercent}));
          }
        } else {
          const st = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
          if (st.driverPercent !== undefined) driverPercentEl.value = st.driverPercent;
        }
      } catch (err) {
        console.warn("Could not load settings from Firestore:", err);
        const st = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
        if (st.driverPercent !== undefined) driverPercentEl.value = st.driverPercent;
      }
    }

    driverPercentEl.addEventListener('change', async ()=>{
      const v = Number(driverPercentEl.value) || 0;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({driverPercent: v}));
      try {
        await setDoc(settingsDocRef, { driverPercent: v }, { merge: true });
      } catch(e) { console.warn("Settings save failed:", e); }
      render();
      updateStats();
    });

    // language toggle click
    langToggleBtn.addEventListener('click', ()=>{
      currentLang = currentLang === 'en' ? 'bn' : 'en';
      applyLanguage(currentLang);
      localStorage.setItem("lang", currentLang);
    });

    function saveLocalEntries(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

    // Firestore query and realtime listener
    const q = query(entriesCol, orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      const docs = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        docs.push({
          id: docSnap.id,
          date: data.date || new Date().toISOString().slice(0,10),
          driver: data.driver || "",
          rent: Number(data.rent || 0),
          fuel: Number(data.fuel || 0),
          extra: Number(data.extra || 0),
          notes: data.notes || ""
        });
      });
      entries = docs;
      saveLocalEntries();
      render();
      updateStats();
    }, (err) => {
      console.warn("Firestore snapshot error:", err);
      render();
      updateStats();
    });

    async function upsertEntryToFirestore(obj) { 
      try { 
        const docRef = doc(entriesCol, String(obj.id));
        await setDoc(docRef, { 
          date: obj.date, driver: obj.driver, rent: obj.rent, fuel: obj.fuel, extra: obj.extra, notes: obj.notes,
          createdAt: Date.now()
        }, { merge: true });
      } catch (e) { console.error("upsert failed", e); }
    }

    async function deleteEntryFromFirestore(id) { 
      try { await deleteDoc(doc(entriesCol, String(id))); } catch (e) { console.error("delete failed", e); }
    }

    document.getElementById('entryForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if(!driverEl.value.trim()){ alert(t('driver_name_required')); return; }
      const obj = {
        id: editingId || Date.now(),
        date: dateEl.value || new Date().toISOString().slice(0,10),
        driver: driverEl.value.trim(),
        rent: Number(rentEl.value)||0,
        fuel: Number(fuelEl.value)||0,
        extra: Number(extraEl.value)||0,
        notes: notesEl.value||''
      };
      if(editingId){ entries = entries.map(x=> x.id===editingId ? obj : x); editingId = null; } else { entries.unshift(obj); }
      saveLocalEntries();
      render(); updateStats();
      await upsertEntryToFirestore(obj);
      document.getElementById('entryForm').reset();
      dateEl.value = new Date().toISOString().slice(0,10);
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('entryForm').reset(); editingId = null; dateEl.value = new Date().toISOString().slice(0,10); });

    document.getElementById('importBtn').addEventListener('click', ()=> importJson.click());
    importJson.addEventListener('change', function(){
      const f = this.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = async (e)=>{
        try{
          const data = JSON.parse(e.target.result);
          if(!Array.isArray(data)) throw 'Invalid';
          for(const item of data){
            const id = item.id || Date.now() + Math.floor(Math.random()*10000);
            const obj = {
              id: id,
              date: item.date || new Date().toISOString().slice(0,10),
              driver: item.driver || '',
              rent: Number(item.rent)||0,
              fuel: Number(item.fuel)||0,
              extra: Number(item.extra)||0,
              notes: item.notes || ''
            };
            await upsertEntryToFirestore(obj);
          }
          alert(t('imported_ok'));
        }catch(err){ alert(t('invalid_json')); }
      };
      r.readAsText(f); this.value='';
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='driver_entries.json'; a.click(); URL.revokeObjectURL(url);
    });

    window.editEntry = function(id){ const e = entries.find(x=>x.id===id); if(!e) return; editingId = id; dateEl.value = e.date; driverEl.value = e.driver; rentEl.value = e.rent; fuelEl.value = e.fuel; extraEl.value = e.extra; notesEl.value = e.notes; window.scrollTo({top:0,behavior:'smooth'}); };

    window.deleteEntry = async function(id){ if(!confirm(t('delete_confirm'))) return; entries = entries.filter(x=> x.id!==id); saveLocalEntries(); render(); updateStats(); await deleteEntryFromFirestore(id); };

    function initCharts(){ try{ const ctx1 = document.getElementById('dailyChart').getContext('2d'); dailyChart = new Chart(ctx1, { type:'line', data:{ labels:[], datasets:[ {label:t('income'), data:[], fill:false, tension:0.3}, {label:t('expense'), data:[], fill:false, tension:0.3} ] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} } }); const ctx2canvas = document.createElement('canvas'); ctx2canvas.style.display='none'; document.body.appendChild(ctx2canvas); }catch(e){console.warn('chart init', e)} }
    function updateStats(){ const totals = {income:0,fuel:0,extra:0}; entries.forEach(e=>{ totals.income += e.rent; totals.fuel += e.fuel; totals.extra += e.extra; }); totals.expense = totals.fuel + totals.extra; totals.profit = totals.income - totals.expense; totalIncomeEl.textContent = format(totals.income); totalExpenseEl.textContent = format(totals.expense); profitEl.textContent = format(totals.profit); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(totals.profit * percent / 100)); driverShareEl.textContent = format(dShare); try{ const daily = {}; entries.forEach(e=>{ if(!daily[e.date]) daily[e.date] = {income:0,expense:0}; daily[e.date].income += e.rent; daily[e.date].expense += (e.fuel + e.extra); }); const dates = Object.keys(daily).sort(); if(dailyChart){ dailyChart.data.labels = dates; dailyChart.data.datasets[0].data = dates.map(d=>daily[d].income); dailyChart.data.datasets[1].data = dates.map(d=>daily[d].expense); dailyChart.update(); } }catch(e){} }
    function render(){ entryCountEl.textContent = entries.length; entriesList.innerHTML = ''; entries.forEach(e=>{ const profit = e.rent - (e.fuel + e.extra); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(profit * percent / 100)); const card = document.createElement('div'); card.className='entry-card'; card.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">'+escapeHtml(e.driver)+'</div><div class="small">'+e.date+' Â· '+format(e.rent)+'</div></div><div style="text-align:right"><div style="font-weight:700">'+t('profit_label')+' '+format(profit)+'</div><div class="small">'+t('driver_label')+' '+format(dShare)+'</div></div></div><div style="display:flex;justify-content:space-between;margin-top:8px;align-items:center"><div class="small">'+escapeHtml(e.notes||'')+'</div><div style="display:flex;gap:8px"><button class="btn" onclick="editEntry('+e.id+')">âœŽ</button><button class="btn" onclick="deleteEntry('+e.id+')">ðŸ—‘</button></div></div>'; card.addEventListener('click', function(ev){ if(ev.target.tagName.toLowerCase() !== 'button') editEntry(e.id); }); entriesList.appendChild(card); }); entriesTable.innerHTML = ''; entries.forEach(e=>{ const profit = e.rent - (e.fuel + e.extra); const percent = Number(driverPercentEl.value)||40; const dShare = Math.max(0, Math.round(profit * percent / 100)); const tr = document.createElement('tr'); tr.innerHTML = '<td>'+e.date+'</td><td>'+escapeHtml(e.driver)+'</td><td>'+format(e.rent)+'</td><td>'+format(e.fuel)+'</td><td>'+format(e.extra)+'</td><td>'+format(profit)+'</td><td>'+format(dShare)+'</td>'; entriesTable.appendChild(tr); }); updateStats(); applyLanguage(currentLang); }

    // simple escape to avoid HTML injection in notes/driver
    function escapeHtml(text){
      return String(text).replace(/[&<>"'=\/]/g, function (s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','':'&#x60;','=':'&#x3D;'})[s];
      });
    }

    // init
    initCharts();
    loadSettings().then(()=>{ render(); updateStats(); });

  </script>
</body>
</html>
